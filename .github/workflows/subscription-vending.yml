name: Subscription Vending & Provisioning

on:
  workflow_dispatch:
  pull_request:
    paths:
      - "requests/**.yaml"
      - ".github/workflows/subscription-vending.yml"
  push:
    branches: [main]
    paths:
      - "requests/**.yaml"

permissions:
  id-token: write
  contents: write
  pull-requests: write

concurrency:
  group: subscription-factory-terraform
  cancel-in-progress: false

jobs:
  # validate:
  #   name: Validate Subscription Request
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 0

  #     - name: Find changed requests
  #       id: changed
  #       run: |
  #         if [ "${{ github.event_name }}" == "pull_request" ]; then
  #           changed_files=$(git diff-name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep "requests/.*\.yaml" || true)
  #         else
  #           changed_files=$(git diff-name-only HEAD~1 HEAD | grep "requests/.*\.yaml" || true)
  #         fi
          
  #         echo "changed_files<<EOF" >> $GITHUB_OUTPUT
  #         echo "$changed_files" >> $GITHUB_OUTPUT
  #         echo "EOF" >> $GITHUB_OUTPUT

  #     - name: Validate request format
  #       run: |
  #         if [ -z "${{ steps.changed.outputs.changed_files }}" ]; then
  #           echo "No subscription requests found"
  #           exit 0
  #         fi
          
  #         for file in ${{ steps.changed.outputs.changed_files }}; do
  #           if [ -f "$file" ]; then
  #             echo "Validating $file..."
              
  #             # Check required fields
  #             yq eval '.subscription_name' "$file" > /dev/null || { echo "Missing subscription_name"; exit 1; }
  #             yq eval '.environment' "$file" > /dev/null || { echo "Missing environment"; exit 1; }
  #             yq eval '.app_code' "$file" > /dev/null || { echo "Missing app_code"; exit 1; }
              
  #             # Validate environment values
  #             env=$(yq eval '.environment' "$file")
  #             if [[ ! "$env" =~ ^(dev|stage|prod|qa|uat|sit)$ ]]; then
  #               echo "Invalid environment: $env. Must be one of: dev, stage, prod, qa, uat, sit"
  #               exit 1
  #             fi

  #             app_code=$(yq eval '.app_code' "$file")
  #             if [[ ! "$app_code" =~ ^[a-z0-9]{3}$ ]]; then
  #               echo "Invalid app_code: $app_code. Must be exactly 3 lowercase alphanumeric characters (e.g., app, crm, erp)"
  #               exit 1
  #             fi
              
  #             echo "✓ $file is valid"
  #           fi
  #         done

  provision:
    name: Provision Subscription
    # needs: validate
    runs-on: ubuntu-latest
    # environment: prod
    # if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    env:
      ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.INFRA_SUBSCRIPTION_ID }}
      ARM_USE_OIDC: true
      TF_VAR_subscription_id_override: ${{ secrets.RFF_SUBSCRIPTION_ID }}
    
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Detect Environment
        id: env
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            changed_files=$(git diff-name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep "requests/" || true)
          else
            changed_files=$(git diff-name-only HEAD~1 HEAD | grep "requests/" || true)
          fi
          
          # Extract environment from first changed request file (e.g., requests/dev/terraform.tfvars -> dev)
          environment=$(echo "$changed_files" | head -1 | cut -d'/' -f2)
          
          if [ -z "$environment" ]; then
            echo "No changes detected in requests/ folder"
            environment="dev"  # Default to dev if no changes
          fi
          
          echo "environment=$environment" >> $GITHUB_OUTPUT
          echo "✓ Detected environment: $environment"

      - name: Terraform Init
        run: terraform init

      - name: Terraform Plan
        env:
          TF_LOG: INFO
          TF_LOG_PATH: terraform.log
        run: terraform plan -var-file="requests/${{ steps.env.outputs.environment }}/terraform.tfvars" -lock-timeout=10m -refresh=false -no-color -out=tfplan

      - name: Terraform Plan Debug Log (on failure)
        if: failure()
        run: |
          echo "---- terraform.log (last 200 lines) ----"
          tail -n 200 terraform.log || true
          
      - name: Check for State Lock Issues
        if: failure() && contains(steps.plan.outputs.stderr, 'state blob is already locked')
        run: |
          echo "⚠️ State lock detected - the previous workflow may have crashed"
          echo "Lock ID: 6e1eb872-cd30-11a2-28ba-dea9d65c26d6"
          echo "Please manually unlock if issue persists: terraform force-unlock <LOCK_ID>"
          exit 1

      - name: Terraform Apply
        run: terraform apply -auto-approve tfplan

      - name: Export Subscription Details
        run: |
          terraform output -json > subscription-outputs.json
          cat subscription-outputs.json
